# RAT — Third-Party License Report
# Generates license notices for all dependencies across all packages.
# Runs weekly and on every release tag to keep reports fresh.
# On schedule/manual: creates a PR with updated reports.
# On release tags: attaches THIRD-PARTY-NOTICES.md as a release asset.

name: Licenses

on:
  schedule:
    - cron: "0 6 * * 1"  # Every Monday at 06:00 UTC
  push:
    tags: ["v*"]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    name: Generate License Reports
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ── Go setup ──
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: platform/go.sum

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      # ── Python setup ──
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python tools + deps
        run: |
          pip install --quiet pip-licenses
          cd runner && pip install --quiet -e . && cd ..
          cd query && pip install --quiet -e . && cd ..

      # ── Node setup ──
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node tools + deps
        run: |
          npm install -g license-checker
          cd sdk-typescript && npm ci && cd ..
          cd portal && npm ci && cd ..
          cd website && npm ci && cd ..

      # ── Generate ──
      - name: Generate license reports
        run: bash scripts/generate-licenses.sh

      # ── Upload artifacts ──
      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            THIRD-PARTY-NOTICES.md
            platform/THIRD-PARTY-NOTICES.md
            runner/THIRD-PARTY-NOTICES.md
            query/THIRD-PARTY-NOTICES.md
            portal/THIRD-PARTY-NOTICES.md
            sdk-typescript/THIRD-PARTY-NOTICES.md
            website/THIRD-PARTY-NOTICES.md
            website/data/licenses.json
          retention-days: 90

      # ── Create PR with updated reports (schedule/manual only) ──
      - name: Create PR with license updates
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(licenses): update third-party license reports"
          title: "chore: update third-party license reports"
          branch: chore/update-licenses
          body: |
            Auto-generated license report update.

            Updates third-party license notices for all components:
            - platform (Go)
            - runner (Python)
            - query (Python)
            - portal (Node.js)
            - sdk-typescript (Node.js)
            - website (Node.js)
          add-paths: |
            THIRD-PARTY-NOTICES.md
            platform/THIRD-PARTY-NOTICES.md
            runner/THIRD-PARTY-NOTICES.md
            query/THIRD-PARTY-NOTICES.md
            portal/THIRD-PARTY-NOTICES.md
            sdk-typescript/THIRD-PARTY-NOTICES.md
            website/THIRD-PARTY-NOTICES.md
            website/data/licenses.json

      # ── Attach to release (tag push only) ──
      - name: Attach THIRD-PARTY-NOTICES.md to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: THIRD-PARTY-NOTICES.md
